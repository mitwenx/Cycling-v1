#!/bin/bash

APP_NAME=$1

if test "$APP_NAME" != "mii"; then
    echo "Usage: ./start mii"
    exit 1
fi

echo ">>> Checking system dependencies..."

MISSING_DEPS=0
if ! command -v python >/dev/null 2>&1; then MISSING_DEPS=1; fi
if ! command -v npm >/dev/null 2>&1; then MISSING_DEPS=1; fi
if ! command -v termux-location >/dev/null 2>&1; then MISSING_DEPS=1; fi

# 1. Install System Packages
if test $MISSING_DEPS -eq 1; then
    echo ">>> First time setup: Installing system packages (Python, Node.js, Termux-API)..."
    pkg update -y
    pkg install python nodejs termux-api -y
    echo ""
    echo "âš ï¸ IMPORTANT: Make sure you ALSO installed the 'Termux:API' app from F-Droid!"
    echo "âš ï¸ Make sure you gave it 'Location' permissions in your Android settings."
    echo ""
    sleep 3
fi

# 2. Setup Python Virtual Environment
if test ! -d "venv"; then
    echo ">>> First time setup: Creating Python virtual environment..."
    python -m venv venv
    source venv/bin/activate
    echo ">>> Installing Python dependencies..."
    pip install -r requirements.txt
else
    source venv/bin/activate
fi

# 3. Build React Frontend
if test ! -d "frontend/dist"; then
    echo ">>> First time setup: Building the React Frontend..."
    cd frontend
    npm install
    npm run build
    cd ..
fi

# 4. Prevent double-starting
if test -f ".mii.pid"; then
    OLD_PID=$(cat .mii.pid)
    if ps -p $OLD_PID > /dev/null 2>&1; then
        echo "miii is already running! (PID: $OLD_PID)"
        echo "To stop it, run: ./stop mii"
        exit 1
    else
        # Process died but PID file remains, clean it up
        rm -f .mii.pid
    fi
fi

# 5. Start the App in the background
echo ">>> Starting miii background service..."
nohup uvicorn main:app --host 0.0.0.0 --port 8000 > miii.log 2>&1 &
NEW_PID=$!
echo $NEW_PID > .mii.pid

# 6. Success Output
echo "====================================================="
echo "ðŸš´ miii is now RUNNING! ðŸš´"
echo "Open Google Chrome on your phone and go to:"
echo "http://localhost:8000"
echo ""
echo "To view live logs: tail -f miii.log"
echo "To stop the app:   ./stop mii"
echo "====================================================="
